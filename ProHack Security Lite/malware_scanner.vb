Imports System.Data.OleDb
Imports System.IO

Public Class malware_scanner

    Public isScanning As Boolean = False
    Public malwareDetected As Boolean = False
    Public scanType As String

    Private ShowDetectionsOnStart As Boolean
    Private settings_isChanged As Boolean

    Sub New()
        InitializeComponent()
        Me.DoubleBuffered = True
    End Sub

    Private Sub btnExit_MouseEnter(sender As Object, e As EventArgs) Handles btnExit.MouseEnter
        Try
            btnExit.BackgroundImage = Image.FromFile(Application.StartupPath & "/res/common_controls/shutdown_hover.png")
        Catch ex As Exception
            utils.invoke_msg(2, "Icon Error", ex.Message.ToString)
        End Try
    End Sub

    Private Sub btnExit_MouseLeave(sender As Object, e As EventArgs) Handles btnExit.MouseLeave
        Try
            btnExit.BackgroundImage = Image.FromFile(Application.StartupPath & "/res/common_controls/shutdown.png")
        Catch ex As Exception
            utils.invoke_msg(2, "Icon Error", ex.Message.ToString)
        End Try
    End Sub

    Private Sub save_settings()
        If ShowDetectionsOnStart = True Then
            utils.scanner_ShowDetectionsOnLoad = "True"
        Else
            utils.scanner_ShowDetectionsOnLoad = "False"
        End If
        utils.save_config()
    End Sub

    Private Sub btnExit_Click(sender As Object, e As EventArgs) Handles btnExit.Click
        If settings_isChanged = True Then
            ' save the settings
            save_settings()
        End If
        close_me(True)
    End Sub

    Private Sub btnToggleScan_MouseEnter(sender As Object, e As EventArgs) Handles btnToggleScan.MouseEnter
        If isScanning = False Then
            btnToggleScan.Image = Image.FromFile(Application.StartupPath & "/res/malware_scanner/rocket_hover.png")
        End If
    End Sub

    Private Sub btnToggleScan_MouseLeave(sender As Object, e As EventArgs) Handles btnToggleScan.MouseLeave
        If isScanning = False Then
            btnToggleScan.Image = Image.FromFile(Application.StartupPath & "/res/malware_scanner/rocket.png")
        End If
    End Sub

    Private Sub btnToggleScan_Click(sender As Object, e As EventArgs) Handles btnToggleScan.Click
        If isScanning = True Then
            ' if scanning, then don't support cancellation.
            utils.tempStr = "Unadvisable to stop background threads in-between work. Please close malware scanner window if you really wish to end the scan.."
            utils.invoke_msg(3, "Scanning!", utils.tempStr)
        ElseIf isScanning = False Then
            ' if not scanning, start scanning
            txtStatus.Text = "Status: Scanning..."
            btnToggleScan.Image = Image.FromFile(Application.StartupPath & "/res/malware_scanner/loading_dark.gif")
            If Not bgWorker_Scanner.IsBusy Then
                Try
                    bgWorker_Scanner.RunWorkerAsync()
                    isScanning = True
                    check_detected_status.Start()
                Catch ex As Exception
                    utils.invoke_msg(3, "Worker Error", ex.Message.ToString)
                End Try
            End If

            txtCalmDown.Text = "Feel free to do other work!"
        End If
    End Sub

    Private Sub malware_scanner_Load(sender As Object, e As EventArgs) Handles MyBase.Load
        settings_isChanged = False
        scanType = mainWindow.scanType
        lblSubTitle.Text = scanType & " Scan"
        progressBar1.Style = ProgressBarStyle.Continuous
        isScanning = False

        ' scanner settings
        If utils.scanner_ShowDetectionsOnLoad = "True" Then
            'set the show detections to true
            ShowDetectionsOnStart = True
            cb_ShowSavedDetections.Checked = True
        ElseIf utils.scanner_ShowDetectionsOnLoad = "False" Then
            'set the show detections to false   
            ShowDetectionsOnStart = False
            cb_ShowSavedDetections.Checked = False
        Else
            'if something else, then default true
            ShowDetectionsOnStart = True
            cb_ShowSavedDetections.Checked = True
        End If

        If lblSubTitle.Text = "Quick Scan" Then
            cb_ExtensionBased.Visible = True
            If utils.scanner_QuickScan_ExtensionBased = "True" Then
                cb_ExtensionBased.CheckState = CheckState.Checked
            ElseIf utils.scanner_QuickScan_ExtensionBased = "False" Then
                cb_ExtensionBased.CheckState = CheckState.Unchecked
            End If
        Else
            cb_ExtensionBased.Visible = False
        End If

        ' show malware informer if previous detections settings is true 
        If ShowDetectionsOnStart = True Then
            malware_informer.Show()
        End If
    End Sub

    Private Sub bgWorker_Scanner_DoWork(sender As Object, e As System.ComponentModel.DoWorkEventArgs) Handles bgWorker_Scanner.DoWork
        ' reusable declares
        Dim FilesAndHashes As New List(Of String)() ' save filepaths and hashes

        ' file operating declares
        Dim file_bytes() As Byte                     ' store file bytes in byte array
        Dim file_bytes_size As Integer               ' size of file_bytes array
        Dim lineBytes() As Byte                      ' store line bytes in byte array
        Dim lineBytes_size As Integer                ' size of lineBytes array
        Dim totalRead_size As Integer                ' size of total line bytes
        Dim temp_file_paths As New List(Of String)() ' store filepaths temporarily

        ' common declares : comparer
        Dim malware_hash_counter As Integer = 0    ' store count of something
        Dim len_hash_files As Integer = 0          ' store length of hash files


        ' other declares : comparer
        Dim hashfile_lineArray() As String              ' string array to store 2 signature from each line in malware db file
        Dim malware_hash_store As New List(Of String)() ' store malware hashes in list

        ' -- operations according to scan types -- '

        ' quick scan
        If scanType = "Quick" Then
            If cb_ExtensionBased.CheckState = CheckState.Checked Then ' -- scan based on extensions
                ' read the WSIR file
                utils.reader = My.Computer.FileSystem.OpenTextFileReader(utils.WSIR_file)
                ' get file bytes
                file_bytes = File.ReadAllBytes(utils.WSIR_file)
                ' get size of file bytes in integer
                file_bytes_size = file_bytes.Length
                Do
                    ' store each filepath in tempString variable
                    utils.tempStr = utils.reader.ReadLine
                    ' if tempString is not null or empty
                    If Not String.IsNullOrEmpty(utils.tempStr) Then
                        ' get line bytes
                        lineBytes = System.Text.Encoding.ASCII.GetBytes(utils.tempStr)
                        ' get line bytes size in integer
                        lineBytes_size = lineBytes.Length
                        ' add line bytes size to total size read
                        totalRead_size += lineBytes_size
                        Try
                            ' add the filepath to list
                            ' this is faster than generating md5 on the go :-)
                            ' first we will store all the absolute filepaths in the memory, then find file signature
                            temp_file_paths.Add(utils.tempStr)
                        Catch ex As Exception : End Try ' idk what to do if exception. can do many things, but leaving it..
                    End If
                    bgWorker_Scanner.ReportProgress(CInt(totalRead_size * 100 / file_bytes_size))
                Loop Until utils.tempStr Is Nothing
                'close reader
                utils.reader.Close()
                'report progress 0
                bgWorker_Scanner.ReportProgress(0)

                ' declares for hashing
                Dim filenumbers As Integer = temp_file_paths.Count  ' get number of files in file path array
                ' set counter to 0
                utils.tempCounter = 0

                ' for each file in file_paths
                For Each filepath In temp_file_paths
                    ' try to
                    Try
                        ' generate MD5 signature for the file 
                        ' and store it in tempString
                        utils.tempStr = utils._MD5_(filepath)
                        ' concatenate file path with md5 hash
                        utils.tempStr = filepath & " |+| " & utils.tempStr
                        ' add to file and hashes list
                        FilesAndHashes.Add(utils.tempStr)
                    Catch ex As Exception : End Try ' idk
                    utils.tempCounter += 1 ' increment the counter
                    ' report progress
                    bgWorker_Scanner.ReportProgress(utils.tempCounter * 100 / filenumbers)
                Next
                ' report progress as 100
                bgWorker_Scanner.ReportProgress(100)
            ElseIf cb_ExtensionBased.CheckState = CheckState.Unchecked Then ' -- scan based on file list
                Dim common_dirs As New List(Of String)()

                ' common dirs to gather files from
                common_dirs.Add("C:\\")

                For Each common_dir In common_dirs

                    ' write quick scan
                    utils.writer = New StreamWriter(utils.pyModDir & "list_from.txt")
                    utils.writer.WriteLine("quick")
                    utils.writer.Close()
                    utils.writer.Dispose()

                    ' start python script
                    Dim command As String = utils.pyModDir & "Sys_File_Lister.py"
                    Try
                        Process.Start(utils.python_Path, """" + command + """").WaitForExit()
                    Catch ex As Exception
                        MsgBox(ex.Message.ToString)
                        BeginInvoke(CType(Sub()
                                              SecLite_Settings.Show()
                                              SecLite_Settings.tabpage_python.Select()
                                              close_me(False)
                                          End Sub, MethodInvoker))
                    End Try

                    ' -- following results in errors, so not used. Maybe will try a fix later.
                    '' command for starting python script
                    'Dim command As String = utils.pyModDir & "Sys_File_Lister.py"
                    ''Try

                    ''    'MsgBox(utils.python_Path)
                    ''    Process.Start(utils.python_Path, """" + command + """").WaitForExit()
                    ''Catch ex As Exception
                    ''    MsgBox(ex.Message.ToString)
                    ''End Try
                    'Using proc As New Process()
                    '    ' set the filename for process
                    '    proc.StartInfo.FileName = "cmd.exe"
                    '    ' set the arguments for process
                    '    proc.StartInfo.Arguments = utils.python_Path & " " & """" & command & """"
                    '    MsgBox(proc.StartInfo.Arguments.ToString)
                    '    Try
                    '        ' start the process
                    '        proc.Start()
                    '        ' wait for the process to complete
                    '        proc.WaitForExit()
                    '        ' if error
                    '    Catch ex As Exception
                    '        MsgBox(ex.Message.ToString)
                    '        BeginInvoke(CType(Sub()
                    '                              SecLite_Settings.Show()
                    '                              SecLite_Settings.SmallTabControl1.SelectTab(1)
                    '                              close_me(False)
                    '                          End Sub, MethodInvoker))
                    '    End Try
                    'End Using

                    Dim filelist As String = Application.StartupPath & "/python_modules/data/File_List.list"
                    ' read the WSIR file
                    utils.reader = My.Computer.FileSystem.OpenTextFileReader(filelist)
                    ' get file bytes
                    file_bytes = File.ReadAllBytes(filelist)
                    ' get size of file bytes in integer
                    file_bytes_size = file_bytes.Length
                    Do
                        ' store each filepath in tempString variable
                        utils.tempStr = utils.reader.ReadLine
                        ' if tempString is not null or empty
                        If Not String.IsNullOrEmpty(utils.tempStr) Then
                            ' get line bytes
                            lineBytes = System.Text.Encoding.ASCII.GetBytes(utils.tempStr)
                            ' get line bytes size in integer
                            lineBytes_size = lineBytes.Length
                            ' add line bytes size to total size read
                            totalRead_size += lineBytes_size
                            Try
                                ' add the filepath to list
                                ' this is faster than generating md5 on the go :-)
                                ' first we will store all the absolute filepaths in the memory, then find file signature
                                temp_file_paths.Add(utils.tempStr)
                            Catch ex As Exception : End Try ' idk what to do if exception. can do many things, but leaving it..
                        End If
                        'bgWorker_Scanner.ReportProgress(CInt(totalRead_size * 100 / file_bytes_size))
                    Loop Until utils.tempStr Is Nothing
                    'close reader
                    utils.reader.Close()
                    'report progress 0
                    bgWorker_Scanner.ReportProgress(40)

                    ' declares for hashing
                    Dim filenumbers As Integer = temp_file_paths.Count  ' get number of files in file path array
                    ' set counter to 0
                    utils.tempCounter = 0

                    ' for each file in file_paths
                    For Each filepath In temp_file_paths
                        ' try to
                        Try
                            ' generate MD5 signature for the file 
                            ' and store it in tempString
                            utils.tempStr = utils._MD5_(filepath)
                            ' concatenate file path with md5 hash
                            utils.tempStr = filepath & " |+| " & utils.tempStr
                            ' add to file and hashes list
                            FilesAndHashes.Add(utils.tempStr)
                        Catch ex As Exception : End Try ' idk
                        utils.tempCounter += 1 ' increment the counter
                        ' report progress
                        bgWorker_Scanner.ReportProgress(utils.tempCounter * 100 / filenumbers)
                    Next
                    ' report progress as 100
                    bgWorker_Scanner.ReportProgress(100)
                Next
            End If
        ElseIf scanType = "Deep" Then
            ' write deep scan
            utils.writer = New StreamWriter(utils.pyModDir & "list_from.txt")
            utils.writer.WriteLine("deep")
            utils.writer.Close()
            utils.writer.Dispose()
            ' command for starting python script
            Dim command = utils.pyModDir & "Sys_File_Lister.py"
            ' for proc as new process
            Using proc As New Process()
                ' set the filename for process
                proc.StartInfo.FileName = utils.python_Path
                ' set the arguments for process
                proc.StartInfo.Arguments = """" & command & """"
                Try
                    ' start the process
                    proc.Start()
                    ' wait for the process to complete
                    proc.WaitForExit()
                    ' if error
                Catch ex As Exception
                    MsgBox(ex.Message.ToString)
                    BeginInvoke(CType(Sub()
                                          SecLite_Settings.Show()
                                          SecLite_Settings.tabpage_python.Select()
                                          close_me(False)
                                      End Sub, MethodInvoker))
                End Try
            End Using
            Dim filelist As String = Application.StartupPath & "/python_modules/data/File_List.list"
            ' read the WSIR file
            utils.reader = My.Computer.FileSystem.OpenTextFileReader(filelist)
            ' get file bytes
            file_bytes = File.ReadAllBytes(filelist)
            ' get size of file bytes in integer
            file_bytes_size = file_bytes.Length
            Do
                ' store each filepath in tempString variable
                utils.tempStr = utils.reader.ReadLine
                ' if tempString is not null or empty
                If Not String.IsNullOrEmpty(utils.tempStr) Then
                    ' get line bytes
                    lineBytes = System.Text.Encoding.ASCII.GetBytes(utils.tempStr)
                    ' get line bytes size in integer
                    lineBytes_size = lineBytes.Length
                    ' add line bytes size to total size read
                    totalRead_size += lineBytes_size
                    Try
                        ' add the filepath to list
                        ' this is faster than generating md5 on the go :-)
                        ' first we will store all the absolute filepaths in the memory, then find file signature
                        temp_file_paths.Add(utils.tempStr)
                    Catch ex As Exception : End Try ' idk what to do if exception. can do many things, but leaving it..
                End If
                bgWorker_Scanner.ReportProgress(CInt(totalRead_size * 100 / file_bytes_size))
            Loop Until utils.tempStr Is Nothing
            'close reader
            utils.reader.Close()
            'report progress 0
            bgWorker_Scanner.ReportProgress(0)

            ' declares for hashing
            Dim filenumbers As Integer = temp_file_paths.Count  ' get number of files in file path array
            ' set counter to 0
            utils.tempCounter = 0

            ' for each file in file_paths
            For Each filepath In temp_file_paths
                ' try to
                Try
                    ' generate MD5 signature for the file 
                    ' and store it in tempString
                    utils.tempStr = utils._MD5_(filepath)
                    ' concatenate file path with md5 hash
                    utils.tempStr = filepath & " |+| " & utils.tempStr
                    ' add to file and hashes list
                    FilesAndHashes.Add(utils.tempStr)
                Catch ex As Exception : End Try ' idk
                utils.tempCounter += 1 ' increment the counter
                ' report progress
                bgWorker_Scanner.ReportProgress(utils.tempCounter * 100 / filenumbers)
            Next
            ' report progress as 100
            bgWorker_Scanner.ReportProgress(100)
        End If

        ' -- comparison -- '

        ' for each system file hash, compare with malware hash
        ' get all malware hash files from the malware db folder
        Dim malware_hash_files() As String = IO.Directory.GetFiles(Application.StartupPath & "/data/malware_hashes/")
        ' get length of malware hash file array (get the number of files)
        len_hash_files = malware_hash_files.Count
        ' for each malware hash db file, read the file
        ' and compare each hash in the malware db file with each hash from file hash list
        For Each malware_hash_file In malware_hash_files
            ' read the malware hash db file
            utils.reader = New StreamReader(malware_hash_file)
            ' loop over each line
            ' one line comsists of two signatures - packed & unpacked file signatures
            Do
                ' read the line into the temp variable
                utils.tempStr = utils.reader.ReadLine
                ' perform check for value not being null or empty
                ' because in some cases, the variable stores null values and invokes many problems
                If Not String.IsNullOrEmpty(utils.tempStr) Then
                    ' seperate the packaed and unpacked hash
                    ' and add both to hashfile_lineArray
                    hashfile_lineArray = Split(utils.tempStr, ",")
                    ' add both parts in lineArray to malware hash list
                    For Each hashPart In hashfile_lineArray
                        malware_hash_store.Add(hashPart)
                    Next
                End If
                ' update malware_scanrner progressbar
                bgWorker_Scanner.ReportProgress(malware_hash_counter * 100 / len_hash_files)
            Loop Until utils.tempStr Is Nothing ' loop until the variable is nothing (till the end)
            ' cleaning operations
            utils.reader.Close()   ' close file reader
            utils.tempStr = Nothing ' clean the temporary string variable

            ' declares for storing matched hashes and files
            Dim matched_hashes As New List(Of String)()
            Dim matched_files As New List(Of String)()

            ' get length of FilesAndHashes
            len_hash_files = FilesAndHashes.Count
            ' set counter to 0
            utils.tempCounter = 0
            ' for each file hash in list of file hashes
            For Each FileAndHash In FilesAndHashes
                hashfile_lineArray = Split(FileAndHash, " |+| ")
                ' for each malware hash in previous stored malware hash list
                ' compare Hash value from FileAndHash
                For Each malware_hash In malware_hash_store
                    ' if comparison is true, then detected
                    If hashfile_lineArray(1) = malware_hash Then
                        ' add file name to matched list
                        matched_files.Add(hashfile_lineArray(0))
                        ' add hash to matched list
                        matched_hashes.Add(hashfile_lineArray(1))
                        ' mark the status as malware detected in malware_scanner
                        malwareDetected = True
                    End If
                Next
                ' increment the counter for progress status
                utils.tempCounter += 1
                ' show progress in malware_scanner
                bgWorker_Scanner.ReportProgress(utils.tempCounter * 100 / len_hash_files)
            Next

            ' save matches to file ( not adding if statement for malwareDetected because I don't want to \[-_-]/ )
            utils.writer = New StreamWriter(utils.dectected_malware_file)
            ' get length of matched hashes list
            Dim len_detections As Integer = matched_hashes.Count
            ' increment over matched hashes using the length
            For x As Integer = 0 To (len_detections - 1)
                ' concatenate filepath and hash to save into one line
                utils.tempStr = matched_files(x) & " |+| " & matched_hashes(x)
                ' write line in the file with tempString
                utils.writer.WriteLine(utils.tempStr)
            Next
            ' close writer
            utils.writer.Close()
            malware_hash_counter += 1
        Next

        ' collect garbage
        GC.Collect()
    End Sub

    Private Sub bgWorker_Scanner_ProgressChanged(sender As Object, e As System.ComponentModel.ProgressChangedEventArgs) Handles bgWorker_Scanner.ProgressChanged
        Try
            progressBar1.Value = e.ProgressPercentage
        Catch ex As Exception
            utils.invoke_msg(3, "Worker Error", ex.Message.ToString)
        End Try
        txtStatus.Text = e.ProgressPercentage.ToString() + "% Done"
    End Sub

    Private Sub bgWorker_Scanner_RunWorkerCompleted(sender As Object, e As System.ComponentModel.RunWorkerCompletedEventArgs) Handles bgWorker_Scanner.RunWorkerCompleted
        isScanning = False
        If check_detected_status.Enabled = True Then
            check_detected_status.Enabled = False
        End If
        progressBar1.Value = 100
        txtCalmDown.Text = ""
        btnToggleScan.Image = Image.FromFile(Application.StartupPath & "/res/malware_scanner/rocket.png")
        If e.Error IsNot Nothing Then
            ' if error
            utils.invoke_msg(2, "Worker Error", e.Error.ToString)
        Else
            ' if normal completed, show detections window
            If malwareDetected = True Then
                malware_informer.Show()
                close_me(False)
            Else
                utils.invoke_msg(1, "You're Safe!", "You seem to be safe :)")
        End If
        End If
        GC.Collect()
    End Sub

    Private Sub malware_scanner_MouseDown(sender As Object, e As MouseEventArgs) Handles MyBase.MouseDown
        utils.Form_MouseDown(Me, e)
    End Sub

    Private Sub malware_scanner_MouseMove(sender As Object, e As MouseEventArgs) Handles MyBase.MouseMove
        utils.Form_MouseMove(Me, e)
    End Sub

    Private Sub malware_scanner_MouseUp(sender As Object, e As MouseEventArgs) Handles MyBase.MouseUp
        utils.Form_MouseUp(Me, e)
    End Sub

    Private Sub btnMinimize_MouseEnter(sender As Object, e As EventArgs) Handles btnMinimize.MouseEnter
        Try
            btnMinimize.BackgroundImage = Image.FromFile(Application.StartupPath & "/res/common_controls/minimize_hover.png")
        Catch ex As Exception
            utils.invoke_msg(2, "Icon Error", ex.Message.ToString)
        End Try
    End Sub

    Private Sub btnMinimize_MouseLeave(sender As Object, e As EventArgs) Handles btnMinimize.MouseLeave
        Try
            btnMinimize.BackgroundImage = Image.FromFile(Application.StartupPath & "/res/common_controls/minimize.png")
        Catch ex As Exception
            utils.invoke_msg(2, "Icon Error", ex.Message.ToString)
        End Try
    End Sub

    Private Sub close_me(showMain As Boolean)
        If utils.core_FadeEffect = "True" Then
            utils.form_fadeOut(Me)
        End If
        If showMain = True Then
            mainWindow.Show()
        End If
        GC.Collect()
        Me.Close()
    End Sub

    Private Sub btnMinimize_Click(sender As Object, e As EventArgs) Handles btnMinimize.Click
        If utils.core_FadeEffect = "True" Then
            utils.form_fadeOut(Me)
            check_focused.Start()
        End If
        Me.WindowState = FormWindowState.Minimized
    End Sub

    Private Sub check_focused_Tick(sender As Object, e As EventArgs) Handles check_focused.Tick
        If Me.WindowState = FormWindowState.Normal Then
            utils.form_fadeIn(Me)
            Me.Opacity = 1
            check_focused.Stop()
        End If
    End Sub

    Private Sub Malware_scanner_DoubleClick(sender As Object, e As EventArgs) Handles MyBase.DoubleClick
        If Me.WindowState = FormWindowState.Normal Then
            Me.WindowState = FormWindowState.Maximized
        Else
            Me.WindowState = FormWindowState.Normal
        End If
    End Sub

    Private Sub Cb_ShowSavedDetections_CheckedChanged(sender As Object, e As EventArgs) Handles cb_ShowSavedDetections.CheckedChanged
        settings_isChanged = True
        If cb_ShowSavedDetections.CheckState = CheckState.Checked Then
            ShowDetectionsOnStart = True
            cb_ShowSavedDetections.ForeColor = Color.Lime
        Else
            ShowDetectionsOnStart = False
            cb_ShowSavedDetections.ForeColor = Color.White
        End If
    End Sub

    Private Sub Cb_ExtensionBased_CheckedChanged(sender As Object, e As EventArgs) Handles cb_ExtensionBased.CheckedChanged
        If cb_ExtensionBased.CheckState = CheckState.Checked Then
            utils.scanner_QuickScan_ExtensionBased = "True"
        ElseIf cb_ExtensionBased.CheckState = CheckState.Unchecked Then
            utils.scanner_QuickScan_ExtensionBased = "False"
        End If
        settings_isChanged = True
    End Sub

    Private Sub Check_detected_status_Tick(sender As Object, e As EventArgs) Handles check_detected_status.Tick
        If malwareDetected = True Then
            txtCalmDown.Text = "Heuristics: You may be unsafe!"
            txtCalmDown.ForeColor = Color.Red
        End If
    End Sub
End Class